
# Техническое задание (ТЗ)
**Проект:** Информационная система управления складом с применением методов искусственного интеллекта (WarehouseAI WMS — Slotting & 3D)  
**Версия:** 1.1  
**Дата:** 03.09.2025

## Краткое описание проекта и цели
Цель проекта — разработать информационную систему управления складом, которая автоматически **прогнозирует оптимальную расстановку предметов (slotting)** и **визуализирует схему размещения в виде интерактивной 3D-модели**, с учётом следующих факторов:
- **тип предмета** (габариты, хрупкость, требования по хранению),  
- **популярность / частота выдач** (оборотность SKU),  
- **вес и объём** (физические ограничения полок и ячеек),  
- **ограничения склада** (высота полок, грузоподъёмность, зона доступа).

Ключевые результаты: уменьшение среднего времени комплектации, сокращение длины маршрутов комплектовщиков, повышение плотности размещения с сохранением доступности популярных товарных единиц, наглядная 3D-визуализация текущего и рекомендованного размещения для планирования и контроля.

Суть разработки: бэкенд и интерфейс на C# (веб — Razor Pages / в перспективе — WPF/WinForms для локальных ТСД), ML-подсистема на Python, оптимизатор на основе **генетического алгоритма** (GA), 3D-визуализация (WebGL/Three.js через фронтенд или интеграция 3D-рендера в C#).

## Объём и границы системы
- Включено: прогноз размещения (slotting), генерация 3D-сцены склада, веб-интерфейс для просмотра/принятия рекомендаций, API для интеграций, ML pipeline с GA, базовые интеграции с ERP/OMS, PostgreSQL хранилище.
- Исключено (в M1): полная интеграция с аппаратурой (ТСД), продвинутые RL-подходы, автоматическая роботизация перемещений (будущая фаза).

## Пользовательские интерфейсы
### 1. Графические интерфейсы (C#)
- **Веб UI (Razor Pages):**
  - Дашборд — ключевые метрики (время комплектации, плотность размещения, sMAPE прогнозов).
  - Экран «Расположение» — 2D/3D визуализация текущего и рекомендованного размещения; горячие зоны (hot spots) по обороту.
  - Экран «Задачи» — список заданий на перемещение, подтверждение операций.
  - Конфигуратор алгоритма — параметры GA (population size, mutation rate, crossover type), ограничения полок, приоритеты (минимизация времени/максимизация плотности).
  - Панель "Обучение/Инференс" — запуск обучения, просмотр истории версий модели, Model Card.
- **Локальный клиент/TSД (в перспективе):** упрощённый интерфейс подтверждения действий и сканирования штрихкодов.

### 2. Визуализация 3D
- **Встроенный WebGL canvas (Three.js)** в веб-странице для интерактивного осмотра склада и наложения рекомендованных слотов.
- Возможность экспорта 3D-сцены в формат GLTF/OBJ и загрузки в локальные C#-приложения (если нужно).
- Управление слоями: показать только высокоуровневые зоны, полки, отдельные SKU, heatmap по популярности.

### 3. API
- **REST API (OpenAPI):** эндпоинты для получения текущего размещения, получения рекомендаций, создания заданий на перенос, получения статусов обучения моделей.
  - `/api/v1/slotting/recommend` — POST, тело: список SKU, ограничения, горизонты; ответ: рекомендуемая карта размещения + метрики.
  - `/api/v1/visualization/scene` — GET: 3D сцена (GLTF или JSON описание).
  - `/api/v1/models/train` — POST: запуск обучения/переобучения GA с параметрами.
  - `/api/v1/models/status` — GET: статус последнего обучения, артефакты.
- **Webhooks** — уведомления о завершении обучения, об изменении размещения, об обнаруженных аномалиях.

## Взаимодействие с внешними системами
- **ERP / 1C / OMS:** выгрузка каталога SKU (артикул, габариты, вес, категория), заказов и остатков; загрузка рекомендованных карт размещения и задач на перенос (CSV/REST/SFTP).
- **WMS/TSД:** синхронизация статусов выполнения задач (через API или Message Bus).
- **BI / DWH:** экспорт агрегированных метрик и историй в хранилище аналитики (ETL/Push).
- **Системы печати этикеток / сканеры:** получение и отправка меток ячеек, SSCC-коды.
- **Message Broker (RabbitMQ / Kafka):** обмен событиями (orders.created, inventory.updated, slotting.recommendation.created).

## Архитектура, подсистемы и пайплайн
### Основные подсистемы
1. **Core WMS (C# / ASP.NET):** обработка доменных операций (каталог, остатки, задания), REST API, аутентификация (JWT + RBAC).
2. **Visualization service:** генерация и отдача 3D-сцен (может быть модулем Web UI или отдельным микросервисом на Node.js + Three.js).
3. **ML/Optimization service (Python):**
   - Data ingestion & features engineering;
   - Genetic Algorithm optimizer (GA) — генерирует варианты раскладки и оценивает их с fitness-функцией;
   - ML модели для прогнозов популярности (optional): MLP / TFT;
   - Evaluation & scoring;
4. **Data Store (PostgreSQL):** схемы для операций, исторические данные, feature store; object storage для моделей (S3/minio).
5. **Integration service / ETL:** подключение к ERP/OMS, трансформации, DQ проверки.
6. **Orchestration / Message Bus:** RabbitMQ/Kafka для асинхронных задач и уведомлений.
7. **CI/CD и infra:** Docker, Docker Compose для dev; Helm/K8s для prod.

### Пайплайн (высокоуровнево)
1. **Сбор данных** (заказы, движения, характеристики SKU) → 2. **Preprocessing/Feature Engineering** → 3. **Прогноз популярности** (ML) → 4. **Генетический оптимизатор** (создает кандидаты размещения) → 5. **Оценка кандидатов** (fitness: время комплектации, длина маршрутов, плотность, ограничения) → 6. **Выдача рекомендации** → 7. **Визуализация 3D** → 8. **Оперативная реализация** (задания на перенос) → 9. **Сбор фидбека и мониторинг** → loop.

## Используемые модели и алгоритмы ИИ
- **Генетический алгоритм (GA)** — основной оптимизатор для задачи slotting. Хромосома кодирует распределение SKU по ячейкам/полкам; операторы: специализированный кроссовер (swap/segment), мутация (swap/move), селекция (tournament/roulette).
- **Прогноз спроса / популярности (опционально):** MLP или Temporal Fusion Transformer (TFT) для оценки будущей частоты выдач по SKU. Эти прогнозы используются как признаки в fitness-функции GA.
- **Оценка маршрутов:** эвристический симулятор маршрутов комплектовщика (greedy / nearest neighbor) или более точные алгоритмы VRP/heuristic TSP для оценки времени сборки.
- **Аномалии и правила:** rule-based проверки и Isolation Forest для выявления нетипичных изменений в данных/движениях.

## Методы обучения и требования к данным
### Обучение GA и моделей
- **GA** не требует размеченных данных в традиционном смысле; он оптимизирует fitness-функцию, где метрики вычисляются симуляцией/оценкой на исторических данных (orders history). GA-процессы могут выполняться офлайн на батчах исторических дней/сессий.
- **ML-модели прогнозирования** обучаются supervised: исторические временные ряды продаж/заказов, = 12–24 месяца; дневная/недельная агрегация. Фичи: лаги, скользящие средние, календарные признаки, акции, цена.
### Требования к наборам данных
- Формат: таблицы событий (order_id, sku, qty, timestamp), каталоги SKU (sku, weight, dims, storage_reqs), карты склада (zones, rack_id, capacity), журнал операций (pick/put/transfer).
- Размер: минимум 12 месяцев истории по основным SKU; для корректной оценки slotting желательно иметь 12–24 мес.
- Качество: нет дубликатов, корректные timestamp, валидация габаритов и вместимости, единицы измерения стандартизированы.
- Разделение: для ML — train/val/test по времени (например, 70/15/15 по хронологии).

## Процедуры валидации и тестирования
### ML и оптимизация
- **Backtesting GA recommendations:** применять рекомендованную раскладку на исторические батчи и оценивать метрики (время комплектации, дистанция, % выполненных заказов в SLA).
- **Сравнение с baseline:** текущее размещение + простые эвристики (FIFO, ABC-slotting).
- **Метрики:** среднее время комплектации, средняя длина маршрута, плотность размещения (utilization), sMAPE для прогноза популярности, A/B тестирование в пилоте.
### Системное тестирование
- Unit tests для сервисов, интеграционные тесты API, e2e для UI (Playwright), нагрузочное тестирование API (k6), тесты надежности очередей (chaos test).
### CI/CD gates
- Автоматические проверки качества данных (Great Expectations), линтинг кода, тесты, smoke-тесты перед релизом.

## Варианты и требования к развертыванию
- **Dev/PoC:** Docker Compose (postgres, rabbit, api, mlworker, visualization). Поддержка локальной отладки визуализации через браузер.
- **Prod:** Kubernetes (Helm), managed Postgres (RDS/Postgres Cloud) или k8s-operator; object storage (S3/MinIO); авто-масштабирование ML Workers; PV для моделей.
- **Безопасность:** TLS, OAuth2/JWT, RBAC, секреты в Vault/K8s secrets, ограничение доступа к объектному хранилищу.
- **Резервное копирование:** регулярные бэкапы БД и артефактов моделей.

## Процедуры подготовки к развертыванию
1. Подготовка окружений: `.env` и секреты (строки подключения, JWT key, broker credentials).
2. Запуск миграций БД (EF Core миграции или SQL-скрипты).
3. Импорт справочников SKU и топологии склада (CSV/ETL).
4. Прогрев feature store: генерация фич и прогоны предварительного обучения GA на бенчмарках.
5. Обучение initial model (скрипт `scripts/train_initial.py`) и размещение артефактов в `models/`/S3.
6. Настройка очередей и мониторинга (Prometheus/Grafana), алертов и логирования (ELK/Seq).
7. Smoke-тесты: API health, простой pipeline слота+визуализации, проверка загрузки сцены 3D.
8. План отката: backup/restore, миграции в обратном порядке.

## Нефункциональные требования
- P95 latency API ≤ 200ms при 100 RPS (базовый SLA для internal API).
- Надёжность: RPO ≤ 15 минут, RTO ≤ 1 час для критичных сервисов.
- Логирование: структурированное, трассировка (OpenTelemetry).
- Документация: OpenAPI, Model Cards, runbooks для операций ML.

## Вехи (минимум для сдачи задания)
- **M1 (PoC, 4–6 недель):** прототип GA для slotting + симулятор оценки, Web UI с 3D-рендером статической сцены, базовые API, локальный Compose.
- **M2 (beta):** интеграция с тестовой ERP, автоматизированное обучение GA, версионность моделей, A/B тестирование в пилоте склада.
- **M3 (prod):** K8s-развёртывание, monitoring, SLA, документация и обучение персонала.

---

### Приложение — репозиторий для развития
Репозиторий содержит структуру проекта с файлами: `docs/TZ.md` (этот документ), `api/openapi.yaml`, `infrastructure/docker-compose.yml`, `scripts/train_initial.py`, каркас C# веб-приложения и место для ML-скриптов. Используйте репозиторий как основу и создайте GitHub-репозиторий под своим аккаунтом (инструкции ниже).
